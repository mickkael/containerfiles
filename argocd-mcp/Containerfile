# -------- Stage 1: Build dependencies --------
FROM node:18-bullseye AS builder

ARG TARGETPLATFORM
ARG BUILD_VERSION
ENV BUILD_VERSION=${BUILD_VERSION}

WORKDIR /app

# Install pnpm globally
RUN npm install -g pnpm

# Download and extract the release source
RUN curl -sSL https://github.com/argoproj-labs/mcp-for-argocd/archive/refs/tags/v${BUILD_VERSION}.tar.gz \
    | tar xz --strip-components=1 -C /app

# Install dependencies (no dev)
RUN pnpm install

# Run build (tsup compiles TS â†’ JS)
RUN pnpm run build

# Prune dev dependencies for runtime
RUN pnpm install --prod --ignore-scripts

# -------- Stage 2: Runtime --------
FROM node:18-bullseye-slim

WORKDIR /app

COPY --from=builder /app /app

EXPOSE 3000
ENTRYPOINT ["node", "dist/index.js"]
